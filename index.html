<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Creator Store - Checkout (QR Payment)</title>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- EmailJS SDK (optional fallback) -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e6eef8;margin:0}
    .container{max-width:1000px;margin:24px auto;padding:20px}
    h1{margin:0 0 14px}
    .row{display:flex;gap:16px;align-items:flex-start}
    .col{flex:1}
    label{display:block;margin:8px 0 6px;color:#cbd5e1}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071021;color:#e6eef8}
    .btn{background:#ff7f00;color:#111;padding:10px 14px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
    .muted{color:#94a3b8}
    .qr-box{width:320px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);text-align:center}
    .preview{max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:0.9rem;color:#cbd5e1}
    .notice{margin-top:12px;color:#cbd5e1;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    #status{margin-top:12px}
    .file-label{margin-top:8px;font-size:.9rem;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="container">
    <h1>Checkout — Pay by QR</h1>
    <p class="muted">Scan the QR, pay, upload screenshot + UTR/Txn ID. We'll verify and ship.</p>

    <div class="row">
      <div class="col">
        <form id="checkoutForm">
          <label>Full Name *</label>
          <input id="cName" required>

          <label>Email *</label>
          <input id="cEmail" type="email" required>

          <label>Phone (10 digits) *</label>
          <input id="cPhone" maxlength="10" required>

          <label>Address *</label>
          <textarea id="cAddress" rows="3" required></textarea>

          <label>Delivery</label>
          <select id="cDelivery">
            <option value="delivery">Shipping</option>
            <option value="pickup">Pickup</option>
          </select>

          <label>Payment method</label>
          <select id="cPayment">
            <option value="qr">Pay via QR (upload screenshot)</option>
            <option value="cod">Cash on Delivery</option>
          </select>

          <div id="qrSection" style="margin-top:12px">
            <label>Scan & Pay QR</label>
            <div class="qr-box">
              <img id="qrImage" src="images/qr-sample.png" alt="QR" class="preview" style="max-width:250px">
              <p class="small">Scan this QR with UPI / bank app and pay</p>
            </div>

            <label class="file-label">Upload payment screenshot *</label>
            <input id="payScreenshot" type="file" accept="image/*">

            <label>UTR / Transaction ID *</label>
            <input id="utr" placeholder="Enter UTR / transaction id">
          </div>

          <div style="margin-top:14px">
            <button class="btn" type="submit">Pay / Place Order</button>
          </div>
        </form>

        <div id="status"></div>
      </div>

      <div style="width:320px">
        <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:10px">
          <h3 style="margin:0 0 8px">Order Summary</h3>
          <div id="summaryItems"></div>
          <hr style="border-color:rgba(255,255,255,0.04)">
          <div style="display:flex;justify-content:space-between"><strong>Items</strong><strong id="sumItems">₹0</strong></div>
          <div style="display:flex;justify-content:space-between"><span>Shipping/COD</span><strong id="sumCharge">₹0</strong></div>
          <div style="display:flex;justify-content:space-between;font-weight:800"><span>Grand</span><strong id="sumGrand">₹0</strong></div>
        </div>

        <div class="notice">
          After you upload the screenshot and UTR and click <b>Pay / Place Order</b>:
          <ul>
            <li>We will generate a PDF invoice (contains payment screenshot) and email it to the store owner.</li>
            <li>You will receive a confirmation email: "We received your order — verifying payment."</li>
            <li>If email sending isn't configured, the PDF will download for manual sending.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================
 CONFIG - Edit the values below before testing
 1) GAS_WEBHOOK_URL (recommended): Paste the deployed Google Apps Script web app URL (see instructions below)
 2) If you prefer EmailJS, fill the EMAILJS_* values
 3) OWNER_EMAIL: email that should receive the PDF
================================================= */
const GAS_WEBHOOK_URL = ''; // e.g. 'https://script.google.com/macros/s/AKfycbx.../exec'  - set this if you will use Google Apps Script
const EMAILJS_USER_ID = ''; // optional: 'user_xxx'
const EMAILJS_SERVICE_ID = ''; // optional: 'service_xxx'
const EMAILJS_TEMPLATE_ID = ''; // optional: 'template_xxx'
const OWNER_EMAIL = 'owner@example.com'; // change to your email
/* ================================================== */

/* optional EmailJS init if you fill user id */
if(window.emailjs && EMAILJS_USER_ID) emailjs.init(EMAILJS_USER_ID);

/* ===== Sample cart fallback - if your site has a global `cart` it will be used ===== */
let cart = window.cart || null;
if(!cart){
  cart = [
    { id:101, name:'Arduino UNO R3 (Original)', price:1799, qty:1 },
    { id:102, name:'Arduino Nano (Clone)', price:249, qty:1 },
    { id:103, name:'Raspberry Pi Pico', price:399, qty:1 }
  ];
}

function subtotal(){ return cart.reduce((s,i)=>s + i.price * i.qty, 0); }
function computeCharge(delivery, payment, sub){ if(delivery==='pickup') return 0; if(payment==='cod') return 80; return (sub<1500)?50:0; }

/* render summary */
function renderSummary(){ const list=document.getElementById('summaryItems'); list.innerHTML=''; cart.forEach(i=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.margin='6px 0'; row.innerHTML=`<div>${i.name} × ${i.qty}</div><div>₹${(i.price*i.qty).toLocaleString('en-IN')}</div>`; list.appendChild(row); }); const sub=subtotal(); const charge=computeCharge(document.getElementById('cDelivery').value, document.getElementById('cPayment').value, sub); document.getElementById('sumItems').textContent='₹'+sub.toLocaleString('en-IN'); document.getElementById('sumCharge').textContent='₹'+charge; document.getElementById('sumGrand').textContent='₹'+(sub+charge).toLocaleString('en-IN'); }
renderSummary();

/* UI helpers */
const checkoutForm = document.getElementById('checkoutForm');
const payScreenshot = document.getElementById('payScreenshot');
const statusEl = document.getElementById('status');

function showStatus(msg, isError=false){
  statusEl.innerHTML = `<div style="padding:10px;border-radius:8px;background:${isError?'#3b0f0f':'#072e12'};color:${isError?'#ffb4b4':'#b7f5c9'}">${msg}</div>`;
}

/* file to dataURL */
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(fr.result);
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}

/* generate PDF (jsPDF) */
async function generatePdf(orderDetails, screenshotDataUrl){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
  const margin = 40; let y = margin;
  doc.setFontSize(16); doc.text('Creator Store - Order Invoice', margin, y); y+=26;
  doc.setFontSize(11); doc.text(`Date: ${new Date().toLocaleString()}`, margin, y); y+=18;
  doc.text(`Buyer: ${orderDetails.name}`, margin, y); y+=16;
  doc.text(`Email: ${orderDetails.email}`, margin, y); y+=16;
  doc.text(`Phone: ${orderDetails.phone}`, margin, y); y+=16;
  doc.text(`Address: ${orderDetails.address}`, margin, y); y+=20;
  doc.text('Order items:', margin, y); y+=14;
  doc.setFont(undefined,'bold'); doc.text('Item', margin, y); doc.text('Qty', margin+300, y); doc.text('Price', margin+360, y); doc.setFont(undefined,'normal'); y+=12;
  orderDetails.items.forEach(it=>{
    doc.text(it.name, margin, y); doc.text(String(it.qty), margin+300, y); doc.text('₹'+String(it.price*it.qty), margin+360, y); y+=14; if(y>700){ doc.addPage(); y=margin; }
  });
  y+=8;
  doc.text(`Subtotal: ₹${orderDetails.subtotal}`, margin, y); y+=14;
  doc.text(`Shipping/COD: ₹${orderDetails.charge}`, margin, y); y+=14;
  doc.text(`Grand total: ₹${orderDetails.grand}`, margin, y); y+=18;
  doc.setFontSize(12); doc.text(`UTR/Txn ID: ${orderDetails.utr}`, margin, y); y+=18;
  if(screenshotDataUrl){
    const imgProps = doc.getImageProperties(screenshotDataUrl);
    const maxW = 480; const ratio = imgProps.width / imgProps.height;
    const iw = Math.min(maxW, imgProps.width); const ih = iw / ratio;
    if(y + ih > 800){ doc.addPage(); y = margin; }
    doc.text('Payment screenshot:', margin, y); y += 12;
    doc.addImage(screenshotDataUrl, 'JPEG', margin, y, iw, ih); y += ih + 8;
  }
  doc.setFontSize(10); doc.text('This invoice was generated automatically by Creator Store.', margin, 780);
  const pdfBlob = doc.output('blob');
  const pdfBase64 = await new Promise((resolve)=>{ const reader=new FileReader(); reader.onload=()=>resolve(reader.result.split(',')[1]); reader.readAsDataURL(pdfBlob); });
  return { blob: pdfBlob, base64: pdfBase64 };
}

/* send to Google Apps Script webhook (recommended) */
async function sendToGAS(gasUrl, ownerEmail, buyerEmail, pdfBase64, orderDetails){
  const payload = {
    ownerEmail,
    buyerEmail,
    filename: `invoice_${Date.now()}.pdf`,
    fileBase64: pdfBase64,
    order: orderDetails
  };
  const res = await fetch(gasUrl, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error('GAS webhook responded with ' + res.status);
  return await res.json();
}

/* send via EmailJS fallback (optional) */
async function sendViaEmailJS(ownerEmail, buyerEmail, pdfBase64, orderDetails){
  if(!EMAILJS_USER_ID || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID) throw new Error('EmailJS not configured');
  if(!window.emailjs) throw new Error('EmailJS SDK not loaded');
  emailjs.init(EMAILJS_USER_ID);
  const params = { to_email: ownerEmail, buyer_email: buyerEmail, message: `UTR:${orderDetails.utr} Grand: ₹${orderDetails.grand}`, attachment: pdfBase64 };
  const result = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
  return result;
}

/* Main submit */
checkoutForm.addEventListener('submit', async (e)=>{ e.preventDefault();
  showStatus('Processing order...');
  const name=document.getElementById('cName').value.trim();
  const email=document.getElementById('cEmail').value.trim();
  const phone=document.getElementById('cPhone').value.trim();
  const address=document.getElementById('cAddress').value.trim();
  const delivery=document.getElementById('cDelivery').value;
  const payment=document.getElementById('cPayment').value;
  const utr=document.getElementById('utr').value.trim();

  if(!name||!email||!phone||!address){ showStatus('Please fill required fields', true); return; }
  if(!/^\d{10}$/.test(phone)){ showStatus('Enter valid 10 digit phone', true); return; }

  const screenshotFile = payScreenshot.files[0];
  if(payment==='qr'){ if(!screenshotFile){ showStatus('Please upload payment screenshot', true); return; } if(!utr){ showStatus('Please enter UTR / transaction id', true); return; } }

  const sub=subtotal(); const charge=computeCharge(delivery,payment,sub); const grand=sub+charge;
  const orderDetails = { name, email, phone, address, delivery, payment, utr, items: cart.map(i=>({ id:i.id, name:i.name, price:i.price, qty:i.qty })), subtotal: sub, charge, grand };

  let screenshotDataUrl=null;
  if(screenshotFile){ try{ screenshotDataUrl = await fileToDataUrl(screenshotFile); }catch(err){ showStatus('Failed to read screenshot', true); return; } }

  showStatus('Generating PDF invoice...');
  let pdfRes;
  try{ pdfRes = await generatePdf(orderDetails, screenshotDataUrl); }catch(err){ showStatus('Failed to generate PDF: '+err.message, true); console.error(err); return; }

  // 1) Try GAS webhook if configured
  if(GAS_WEBHOOK_URL && GAS_WEBHOOK_URL.length>10){
    showStatus('Sending invoice to store owner via Apps Script...');
    try{
      const resp = await sendToGAS(GAS_WEBHOOK_URL, OWNER_EMAIL, email, pdfRes.base64, orderDetails);
      showStatus('Order recorded. Confirmation email sent. Thank you!', false);
    }catch(err){
      console.error('GAS error', err);
      showStatus('Failed to send via Apps Script: '+err.message+'. Trying EmailJS fallback...', true);
      // fallthrough to EmailJS or download
    }
  }

  // 2) If GAS not configured or it failed, try EmailJS if configured
  if((!GAS_WEBHOOK_URL || GAS_WEBHOOK_URL.length<10) && EMAILJS_USER_ID && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID){
    showStatus('Sending invoice by EmailJS...');
    try{
      await sendViaEmailJS(OWNER_EMAIL, email, pdfRes.base64, orderDetails);
      showStatus('Order recorded. Confirmation email sent via EmailJS.', false);
    }catch(err){
      console.error('EmailJS error', err);
      showStatus('EmailJS failed: '+err.message+'. Downloading PDF for manual email.', true);
      const url = URL.createObjectURL(pdfRes.blob); const a=document.createElement('a'); a.href=url; a.download=`invoice_${Date.now()}.pdf`; a.click();
    }
  }

  // 3) If neither GAS nor EmailJS configured, download PDF
  if((!GAS_WEBHOOK_URL || GAS_WEBHOOK_URL.length<10) && (!EMAILJS_USER_ID || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID)){
    showStatus('Email sending not configured. Downloading invoice PDF now.');
    const url = URL.createObjectURL(pdfRes.blob); const a=document.createElement('a'); a.href=url; a.download=`invoice_${Date.now()}.pdf`; a.click();
  }

  // Optional: Send mailto to buyer as confirmation (no attachment)
  try{
    const subject=encodeURIComponent('Creator Store — Order received'); const body=encodeURIComponent(`Hi ${name},\n\nWe received your order and payment screenshot (UTR: ${utr}). We will verify payment and ship soon.\n\nOrder total: ₹${grand}\n\nThanks,\nCreator Store`); window.location.href=`mailto:${email}?subject=${subject}&body=${body}`;
  }catch(err){ console.warn('mailto fallback failed', err); }

  // clear cart (you can implement actually clearing your global cart)
  showStatus('Order placed. We will verify and ship once payment is confirmed.', false);
});
</script>
</body>
</html>
